<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="InvestDao">
	<select id="selectKRW" parameterType="String" resultType="Integer">
		select krw from memberinfo where id=#{id}
	</select>
	<update id="updateKRW" parameterType="OrderTrade">
		update memberinfo set krw = krw - #{trd_price} where id=#{id}
	</update>
	<insert id="insertTrade" parameterType="Trade">
		insert into trade values(TRD_SEQ.NEXTVAL, #{id}, #{coincode}, sysdate, #{trd_amt}, #{trd_unit_price}, #{trd_price}, #{trd_div}, #{trd_stu})
	</insert>
 	<update id="upBuyCoin" parameterType="OrderTrade">
		merge into coin
    		using dual on (id=#{id} and coincode=#{coincode})
   		when matched then 
        	update set coin_amt = coin_amt + #{trd_amt}, avg_price = (tot_price + #{trd_price}) / (coin_amt + #{trd_amt}), tot_price = tot_price + #{trd_price}
		when not matched then
			insert values(#{coincode}, #{id}, #{trd_amt}, #{trd_unit_price}, #{trd_price})
	</update>
	<select id="getUsableCoin" parameterType="hashmap" resultType="float">
		SELECT NVL(coin_amt, 0)-NVL((SELECT SUM(trd_amt) FROM trade WHERE id=#{id} and coincode=#{currCoin} and trd_stu=0), 0)
		FROM coin WHERE id=#{id} and coincode = #{currCoin}
	</select>
	<select id="searchCoin" parameterType="String" resultType="CoinInfo">
		select * from coininfo where coincode like '%'||#{keyWord}||'%'  or coinname like '%'||#{keyWord}||'%'
	</select>
	<update id="increaseKRW" parameterType="OrderTrade">
		update memberinfo set krw = krw + #{trd_price} where id=#{id}
	</update>
	<update id="upSellCoin" parameterType="OrderTrade">
		UPDATE coin SET coin_amt = coin_amt - #{trd_amt}, tot_price = tot_price - #{trd_price} WHERE id=#{id} and coincode=#{coincode}
	</update>
</mapper>